<header>
    <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3">
        <div class="container-fluid">
            <div class="d-flex justify-content-end align-items-center w-100 ml-5">
                <div class="today-date" style="display: inline-block; margin-top: 10px; margin-right: 10px;">
                    <div id="countdownTimer" style="display:none; display: inline-block; margin-right: 10px; margin-top: 3px;"></div>
                </div>
            </div>
        </div>
    </nav>
</header>
<script>
    $(document).ready(function () {
        if (updatedRemainingTime > 0) {
            startCountdownTimer(updatedRemainingTime);
        }
        extendCachedSeats();
    });
    var storedRemainingTime = sessionStorage.getItem('remainingTime');
    var movieScheduleCode = sessionStorage.getItem('movieScheduleCode');
    var companyTin = sessionStorage.getItem('companyTin');
    var secondsAdded = sessionStorage.getItem('secondsAdded') === 'true';
    var secondsAddedInPayement = sessionStorage.getItem('secondsAddedInPayement') === 'true';

    var updatedRemainingTime;

    if (secondsAdded && secondsAddedInPayement) {
        updatedRemainingTime = parseInt(storedRemainingTime);
    } else if (!secondsAddedInPayement && !secondsAdded) {
        updatedRemainingTime = parseInt(storedRemainingTime);
    } else {
        updatedRemainingTime = parseInt(storedRemainingTime) + 60;
    }
    var selectedSeats = JSON.parse(sessionStorage.getItem('selectedSeats')) || [];
    function startCountdownTimer() {
        $('#countdownTimer').show();
        countdownInterval = setInterval(function () {
            $('#countdownTimer').text("Time remaining: " + formatTime(updatedRemainingTime));
            updatedRemainingTime--;

            if (updatedRemainingTime <= 0) {
                clearInterval(countdownInterval);
                alert("Booking time expired. Please restart the booking process.");
                sessionStorage.clear();
                window.location.href = '@Url.Action("Index", "CinemaHome")';
            }
            sessionStorage.setItem("remainingTime", updatedRemainingTime);
        }, 1000);
        sessionStorage.setItem('secondsAddedInPayement', 'true');
    }
    function extendCachedSeats() {
        if (!secondsAddedInPayement) {
            var endpoint = 'https://api-hulubeje.cnetcommerce.com/api/ManageSeatCache/ExtendCachedSeatsForSchedule';

            var payload = {
                "schedule": movieScheduleCode,
                "allSeats": selectedSeats,
                "orgTin": companyTin,
                "seconds": updatedRemainingTime
            };

            $.ajax({
                url: endpoint,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (response) {
                    console.log('Success:', response);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        }
        else {
            console.log("already extended cache time");
        }
    }
    function formatTime(seconds) {
        var min = Math.floor(seconds / 60);
        var sec = seconds % 60;
        return min + ":" + (sec < 10 ? "0" : "") + sec;
    }
</script>