@model HulubejeBooking.Models.BusModels.Wrap

@* <partial name="_Navigation" /> *@
<head>
    <title>Confirmation</title>
</head>
<div class="container mt-4">
    @{
        string formattedArrivalTime = "";
        string formattedDepartTime = "";
        string formattedDate = "";
        if (Model?.VwRouteScheduleData != null)
        {
            formattedArrivalTime = Model.VwRouteScheduleData.ArrivalDate.ToString("h:mm tt");
            formattedDepartTime = Model.VwRouteScheduleData.DepartureDate.ToString("h:mm tt");
        }
        formattedDate = Model?.VwRouteScheduleData.Date;
    }
    <div class="row border rounded mb-4 pt-3 bg-dark">
        <div class="col-md-4 text-center">
            <div class="row">
                <div class="col-3 d-flex justify-content-end align-items-center">
                    <p><span style="color: white;"><i class="fas fa-bus fa-3x ml-2"></i></span></p>
                </div>
                <div class="col-9">
                    <h5 class="text-primary mb-0">@Model?.VwRouteScheduleData?.OperatorName</h5>
                    <p class="mb-0" style="color: white"><small>@Model?.VwRouteScheduleData?.PlateNumber</small></p>
                    @if (DateTime.TryParse(formattedDate, out DateTime dateTime))
                    {
                        string date = dateTime.ToString("ddd, MMM d, yyyy");
                        <p class="font-weight-bold mb-0" style="color: white">@date</p>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-4 text-center">
            <div class="row"> 
                <div class="row">
                    <div class="col-3">
                        <p><span style="color: white;"><i class="fas fa-map-marker-alt fa-2x ml-2 mt-2"></i></span></p>
                    </div>
                    <div class="col-9">
                        <h6 class="text-success mb-0">Departure</h6>
                        <p class="mb-0" style="color: white">@Model?.VwRouteScheduleData?.DepatureCity</p>
                        @if (DateTime.TryParse(formattedDepartTime, out DateTime utcDepartTime))
                        {
                            DateTime ethiopianTime = utcDepartTime.ToString("tt").Equals("AM") ? utcDepartTime.AddHours(6) : utcDepartTime.AddHours(-6);
                            <p class="font-weight-bold mb-0" style="color: white">@formattedDepartTime (@ethiopianTime.ToString("h.mm tt") LT)</p>
                        }
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 text-center">
            <div class="row">
                <div class="col-3 d-flex justify-content-end align-items-center">
                    <p><span style="color: white;"><i class="fas fa-arrow-right fa-4x ml-2"></i></span></p>
                </div>
                <div class="col-9">
                    <h6 class="text-danger mb-0">Arrival</h6>
                    <p class="mb-0" style="color: white">@Model?.VwRouteScheduleData?.DestCityName</p>
                    @if (DateTime.TryParse(formattedArrivalTime, out DateTime utcArrivalTime))
                    {
                        DateTime ethiopianArrivalTime = utcArrivalTime.ToString("tt").Equals("AM") ? utcArrivalTime.AddHours(6) : utcArrivalTime.AddHours(-6);
                        <p class="font-weight-bold mb-0" style="color: white">@formattedArrivalTime (@ethiopianArrivalTime.ToString("h.mm tt") LT)</p>
                    }
                </div>
            </div>
        </div>
    </div>
    <div class="header text-center text-dark py-3">
        <h3 class="mb-0"><i class="fas fa-user-friends  mr-2"></i> Passengers</h3>
    </div>
    <div class="row pt-3 mb-3 bg-light">
        @{
            var count = 1;
        }
        @foreach (var passenger in Model.PassengerModelData)
        {

            DateTime originalDate = DateTime.ParseExact(passenger.DOB, "yyyy-MM-dd", null);
            string formattedDateString = originalDate.ToString("MMM-dd-yyyy");
            <div class="mb-4">
                <div class="card border-primary h-100 p-2">
                    <div class="card-body ">
                        <div style=""> 
                            <h5 class="card-title text-primary">@passenger.FirstName</h5>
                        </div>
                        <hr>
                        <div class="row p-2" style="background-color: #e0b300; border-radius: 5px;">
                            <div class="col-md-4 ">
                                <p class="card-text mb-0"><strong>Date of Birth</strong>  <span class="float-right">@formattedDateString</span></p>
                                <p class="card-text mb-0"><strong>Nationality:</strong>  <span class="float-right">@passenger.Nationality</span></p>
                            </div>
                            <div class="col-md-4" id="passenger-@count">
                                <p class="card-text mb-0"><strong>Gender:</strong>  <span class="float-right">@passenger.Gender</span></p>
                                <p class="card-text mb-0"><strong>Phone Number:</strong>  <span class="float-right " >@passenger.PhoneNumber</span></p>
                            </div>
                            <div class="col-md-4">
                                <p class="card-text mb-0"><strong>ID Number </strong>  <span class="float-right">@passenger.PassengerId</span></p>
                                @if (passenger.Email is not null)
                                {
                                    <p class="card-text mb-0"><strong>Email:</strong>  <span class="float-right">@passenger.Email</span></p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            count += 1;
        }
    </div>
    <div style="display: flex;
            justify-content: center;
            align-items: center;">
        <button type="submit" id="confirmButton" class="btn btn-success mb-2">Confirm</button>

    </div>
</div>
<partial name="_Footer" />
@{
    var passengerData = Model?.PassengerModelData;
}
<script>
    var tarrif = "@Model?.VwRouteScheduleData?.Tariff";
    var vehicleOperatorId = "@Model?.VwRouteScheduleData?.VehicleOperatorId";
    var routeScheduleId = "@Model?.VwRouteScheduleData?.Id";
    var routeScheduleDate = "@Model?.VwRouteScheduleData?.Date";
    var index = tarrif.indexOf(' ');
    var result = (index > 0) ? tarrif.substring(0, index) : tarrif;
    var resultAsDouble = parseFloat(result);
    var passengerCount = parseFloat("@Model?.PassengerModelData?.Count");
    var amount = resultAsDouble * passengerCount;
    console.log(amount);
    var passengerId = '#passenger-1';
    var userMobileNumber = "@ViewBag.PhoneNumber";
    var discount = 0;
    var addtionalCharge = 0;
    var grandtotal = resultAsDouble + addtionalCharge - discount;
    var ticketDetail = [];
    var intMale = 181;
    var intFemale = 182;
    @if (passengerData != null)
    {
        @for (var i = 0; i < passengerData.Count; i++)
        {
            var passenger = passengerData[i];

            <text>
                var ticketDetailObject = {
                PhoneNumber: '@passenger.PhoneNumber',
                Gender: '@passenger.Gender',
                Dob: '@passenger.DOB',
                Email: '@passenger.Email',
                IdNumber: '@passenger.PassengerId',
                FirstName: '@passenger.FirstName',
                LastName: '@passenger.LastName',
                MiddleName: '@passenger.MiddleName',
                SeatLayout: '@passenger.SeatId',
                SubTotal: resultAsDouble,
                Discount: discount,
                AdditionalCharge: addtionalCharge,
                GrandTotal: grandtotal,
                IsAutoAssigned: false,
                Longitude: 0,
                Latitude: 0,
                Note: '',
                PickupLocation: 1,
                Region: 1,
                City: 14,
                SubCity: 15,
                MaritalStatus: 183,
                Pnr: "",
            };
            if ('@passenger.Gender' === 'Male') {
                ticketDetailObject.Gender = intMale;
            } else if ('@passenger.Gender' === 'Female') {
                ticketDetailObject.Gender = intFemale;
            }
            ticketDetail.push(ticketDetailObject);
            </text>
        }
    }

    console.log(typeof ticketDetail);
    console.log( ticketDetail);

    $('#confirmButton').on('click', function () {
        var data = {
            AuthorizePaymentData: {
                UserMobileNumber: userMobileNumber,
                SupplierTin: '0000017872',
                SupplierOUD: 'OUD000000048',
                Amount: 0.1,
            },
            PassengerInfoData: {
                PaymentStatus: 86,
                Payer: userMobileNumber,
                RouteSchedule: routeScheduleId,
                Operator: vehicleOperatorId,
                PaymentAmount: amount,
                RouteScheduleDate: routeScheduleDate,
                Platform: 'Web',
                IpAddress: '192.168.1.1',
                Longitude: 9.016595,
                Latitude: 38.7657617,
                PaymentMethod: 144,

                TicketDetail: ticketDetail,
            },
        };
        console.log("data", data);

        $.ajax({
            url: '/PaymentHome/Index',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function (/* response */) {
                window.location.href = "/PaymentOptions/PaymentOption";
            },
            error: function (error) {
                console.error('Error:', error);
            }
        });
    });
</script>